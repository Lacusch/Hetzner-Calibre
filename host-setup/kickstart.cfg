# Generated by Anaconda 34.25.5.17
# Generated by pykickstart v3.32
# Edited manually by lacusch on 2025-08-09
#version=RHEL9
# Use text install
text

%addon com_redhat_kdump --enable --reserve-mb='auto'
%end

# Universal installation source - works with ISO, USB, and VM CD-ROM
# The installer will automatically detect and use the available installation media
cdrom

# Keyboard layouts
keyboard --xlayouts='us'
# System language
lang en_US.UTF-8

# Network configuration: DHCP
network --bootproto=dhcp --device=link --activate --onboot=on --hostname=homelab-server


# Services configuration
services --enabled=sshd,chronyd
firewall --enabled --service=ssh

%packages
@^minimal-environment
openssh-server
openssh-clients
%end

# Run the Setup Agent on first boot
firstboot --enable

# Partition clearing information
clearpart --all --initlabel
# Disk partitioning information
part /boot --fstype="xfs" --size=1024 --asprimary
part /boot/efi --fstype="efi" --size=512 --fsoptions="umask=0077,shortname=winnt"
part swap --fstype="swap" --size=512
part / --fstype="xfs" --grow

# System timezone
timezone UTC --utc
# Set up ntp server
timesource --ntp-server=pool.ntp.org

#Root password
rootpw --lock
# User account
user --groups=wheel --name=szabola --password=$6$BwOpQRxQxB3ItUMM$HZkOhxX3VtRd53aEz8BuMFEOj.vW5eDf86TpvSZt44PfB8QkFhc.Dvc3VD6uZsS4bQhTgwGKce8du8JGuB8to. --iscrypted --gecos="Laszlo M. Szabo"

# Post-installation script to set up SSH keys
%post --log=/var/log/ks-post.log
# Create SSH directory for user
mkdir -p /home/szabola/.ssh
chmod 700 /home/szabola/.ssh

# Add your SSH public key here
cat > /home/szabola/.ssh/authorized_keys << 'EOF'
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIE/htaCAT3gbQDSlPQDhhsUnQO1ML18RuBu6Brrek6mu szabo.lacus.2001@gmail.com
EOF

# Set proper permissions
chmod 600 /home/szabola/.ssh/authorized_keys
chown -R szabola:szabola /home/szabola/.ssh

# Optional: Disable password authentication (comment if you want passworod login alongside key)
sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
sed -i 's/PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
# Post run logging
echo "Kickstart installation completed on $(date)" >> /var/log/ks-post.log
%end
reboot
